<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>自動 MP4／MP3 変換レコーダー（GitHub Pages 対応）</title>
<style>
  body{font-family:sans-serif;padding:20px}
  #video{border:1px solid #ccc;background:#000}
  button{margin:5px;padding:8px 12px}
  button:disabled{opacity:.5}
  #images img{margin:5px;border:1px solid #ddd;width:176px;height:99px}
  #status{margin-top:10px;color:#555}
</style>
</head>
<body>
<h1>自動 MP4／MP3 変換レコーダー</h1>

<video id="video" width="705" height="397" autoplay playsinline muted></video>
<div>
  <button id="startRecord">録画開始</button>
  <button id="stopRecord"  disabled>録画停止</button>
  <button id="capture25">25枚キャプチャ</button>
  <button id="capture1_5">1.5秒キャプチャ</button>
  <button id="clearImages">画像クリア</button>
</div>

<div id="images"></div>
<div id="status"></div>

<!-- ffmpeg.wasm ラッパー -->
<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.8/dist/ffmpeg.min.js"></script>
<script>
(async () => {
  const { createFFmpeg, fetchFile } = FFmpeg;

  /* ① シングルスレッド core を指定（MT 版は SharedArrayBuffer 要件で弾かれる） */
  const ffmpeg = createFFmpeg({
    log: true,
    corePath: "https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js"
  });
  const status = txt => document.getElementById('status').innerText = txt;

  status('FFmpeg をロード中…');
  try {
    await ffmpeg.load();
    status('準備完了。');
  } catch (e) {
    status('FFmpeg のロードに失敗しました: ' + e.message);
    console.error(e);
    return;
  }

  const video = document.getElementById('video');
  const btnStart = document.getElementById('startRecord');
  const btnStop  = document.getElementById('stopRecord');
  const btn25    = document.getElementById('capture25');
  const btn15    = document.getElementById('capture1_5');
  const btnClear = document.getElementById('clearImages');
  const images   = document.getElementById('images');

  let stream, rec, chunks;

  /* 録画開始 */
  btnStart.onclick = async () => {
    try {
      stream = await navigator.mediaDevices.getDisplayMedia({
        video:{width:705,height:397},
        audio:true
      });
    } catch(err){
      alert('画面共有が許可されませんでした: '+err.message);
      return;
    }
    video.srcObject = stream;
    chunks = [];

    /* ③ ブラウザごとの対応状況に応じて MIME を決める */
    const mime =
      MediaRecorder.isTypeSupported('video/webm;codecs=vp8,opus') ?
        'video/webm;codecs=vp8,opus' :
      MediaRecorder.isTypeSupported('video/webm') ?
        'video/webm' :
        '';
    try{
      rec = new MediaRecorder(stream,{ mimeType:mime });
    }catch(err){
      alert('MediaRecorder が使えません: '+err.message);
      return;
    }
    rec.ondataavailable = e => e.data.size && chunks.push(e.data);
    rec.start();

    btnStart.disabled = true;
    btnStop.disabled  = false;
    status('録画中…');
  };

  /* 録画停止 */
  btnStop.onclick = async () => {
    btnStop.disabled = true;
    status('録画停止中…');
    rec.stop();
    stream.getTracks().forEach(t=>t.stop());

    await new Promise(r=>rec.onstop = r);
    status('変換中…しばらくお待ち下さい');

    const webm = new Blob(chunks,{type:'video/webm'});
    await convertAndDownload(webm);
    status('完了しました');
    btnStart.disabled = false;
  };

  /* 静止画キャプチャ関連はそのまま */
  function snap(){
    if(!video.srcObject) return alert('先に録画を開始してください');
    const c=document.createElement('canvas');
    c.width=705;c.height=397;
    c.getContext('2d').drawImage(video,0,0);
    const img=document.createElement('img');
    img.src=c.toDataURL('image/png');
    images.appendChild(img);
  }
  btn25.onclick = async()=>{for(let i=0;i<25;i++){snap();await new Promise(r=>setTimeout(r,1000));}}
  btn15.onclick = ()=>{
    let n=0,iv=setInterval(()=>{if(n++>=25)return clearInterval(iv);snap();},1500);
  };
  btnClear.onclick = ()=>images.innerHTML='';

  /* WebM → MP4 / MP3 変換 */
  async function convertAndDownload(blob){
    ffmpeg.FS('writeFile','in.webm',await fetchFile(blob));

    /* MP4 */
    await ffmpeg.run(
      '-i','in.webm',
      '-c:v','libx264','-preset','fast','-crf','23',
      '-c:a','aac','-b:a','128k',
      'out.mp4'
    );
    download('out.mp4','recording.mp4','video/mp4');

    /* MP3 */
    await ffmpeg.run(
      '-i','in.webm','-vn',
      '-q:a','0',
      'out.mp3'
    );
    download('out.mp3','recording.mp3','audio/mpeg');

    /* 後片付け */
    ['in.webm','out.mp4','out.mp3'].forEach(f=>ffmpeg.FS('unlink',f));
  }

  function download(name, saveAs, mime){
    const data = ffmpeg.FS('readFile',name);
    const url  = URL.createObjectURL(new Blob([data.buffer],{type:mime}));
    const a    = Object.assign(document.createElement('a'),{href:url,download:saveAs});
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }
})();
</script>
</body>
</html>
