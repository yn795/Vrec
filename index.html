<!-- 変更点だけ抜粋  -->
...
<div id="downloads"></div> <!-- 追加：ダウンロードリンク置き場 -->

<script>
(async () => {
  /* FFmpeg をロード ... （前回と同じ） */

  // ---- 省略 ----

  // WebM → MP4／MP3 変換
  async function convertAndDownload(blob) {
    ffmpeg.FS('writeFile', 'in.webm', await fetchFile(blob));

    /* ▼▼ MP4（自動） ▼▼ */
    await ffmpeg.run(
      '-i','in.webm',
      '-c:v','libx264','-preset','fast','-crf','23',
      '-c:a','aac','-b:a','128k',
      'out.mp4'
    );
    autoDownload('out.mp4', 'recording.mp4', 'video/mp4');

    /* △△ MP4 ここまで △△ */

    /* ▼▼ MP3（リンクだけ設置） ▼▼ */
    await ffmpeg.run(
      '-i','in.webm','-vn',
      '-c:a','libmp3lame','-b:a','128k',
      'out.mp3'
    );
    makeLink('out.mp3', 'recording.mp3', 'audio/mp3');

    /* △△ MP3 ここまで △△ */

    // 後始末
    ['in.webm','out.mp4','out.mp3'].forEach(f => ffmpeg.FS('unlink', f));
  }

  /* 1. MP4 は従来どおり自動クリック */
  function autoDownload(nameInFS, fileName, mime) {
    const data = ffmpeg.FS('readFile', nameInFS);
    const url  = URL.createObjectURL(new Blob([data.buffer], { type: mime }));
    const a    = Object.assign(document.createElement('a'), {
      href: url, download: fileName, style: 'display:none'
    });
    document.body.appendChild(a);
    a.click();         // ← 1 度目は許可される
    document.body.removeChild(a);
    // url はリンク作成後に revoke すると Safari で開けなくなる場合があるので少し待つ
    setTimeout(() => URL.revokeObjectURL(url), 5000);
  }

  /* 2. MP3 はリンクをページに表示（ユーザーがクリック） */
  function makeLink(nameInFS, fileName, mime) {
    const data = ffmpeg.FS('readFile', nameInFS);
    const url  = URL.createObjectURL(new Blob([data.buffer], { type: mime }));
    const dl   = document.getElementById('downloads');
    dl.innerHTML = ''; // 古いリンクを消す
    const link = document.createElement('a');
    link.href = url;
    link.download = fileName;
    link.textContent = '▼ MP3 を保存 (' + fileName + ')';
    link.style.display = 'inline-block';
    link.style.marginTop = '8px';
    dl.appendChild(link);
  }
})();
</script>
