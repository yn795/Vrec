<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è‡ªå‹•MP4 / MP3 å¤‰æ›ãƒ¬ã‚³ãƒ¼ãƒ€ãƒ¼ï¼ˆãƒ‡ãƒãƒƒã‚°ä»˜ãï¼‰</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #video { border: 1px solid #ccc; background:#000; }
    button { margin: 5px; padding: 10px; }
    #images img { margin:5px; border:1px solid #ddd; }
  </style>
</head>
<body>
  <h1>ãƒ‡ãƒãƒƒã‚°ä»˜ã è‡ªå‹• MP4 / MP3 å¤‰æ›ãƒ¬ã‚³ãƒ¼ãƒ€ãƒ¼</h1>
  <video id="video" width="705" height="397" autoplay playsinline></video><br>
  <button id="startRecord">éŒ²ç”»é–‹å§‹</button>
  <button id="stopRecord" disabled>éŒ²ç”»åœæ­¢</button>
  <button id="capture25">25æšã‚­ãƒ£ãƒ—ãƒãƒ£</button>
  <button id="capture1_5">1.5ç§’ã‚­ãƒ£ãƒ—ãƒãƒ£</button>
  <button id="clearImages">ç”»åƒã‚¯ãƒªã‚¢</button>

  <div id="images"></div>

  <!-- ffmpeg.wasm -->
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.8/dist/ffmpeg.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const startBtn   = document.getElementById('startRecord');
      const stopBtn    = document.getElementById('stopRecord');
      const cap25Btn   = document.getElementById('capture25');
      const cap1_5Btn  = document.getElementById('capture1_5');
      const clearBtn   = document.getElementById('clearImages');
      const videoElem  = document.getElementById('video');
      const imagesDiv  = document.getElementById('images');

      let stream, recorder, chunks = [];

      // éŒ²ç”»é–‹å§‹
      startBtn.addEventListener('click', async () => {
        try {
          stream = await navigator.mediaDevices.getDisplayMedia({
            video: { width: 705, height: 397 },
            audio: true
          });
        } catch (e) {
          console.error('getDisplayMedia error:', e);
          alert('ç”»é¢å…±æœ‰ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸï¼š' + e);
          return;
        }
        videoElem.srcObject = stream;
        chunks = [];

        try {
          recorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp8,opus' });
        } catch (e) {
          console.error('MediaRecorder error:', e);
          alert('MediaRecorder éå¯¾å¿œï¼š' + e);
          return;
        }

        recorder.addEventListener('dataavailable', e => {
          if (e.data.size) chunks.push(e.data);
        });

        recorder.addEventListener('stop', async () => {
          console.log('â¹ recorder stop event fired');
          const blob = new Blob(chunks, { type: 'video/webm' });
          await convertWithFFmpeg(blob);
        });

        recorder.start();
        startBtn.disabled = true;
        stopBtn.disabled  = false;
      });

      // éŒ²ç”»åœæ­¢
      stopBtn.addEventListener('click', () => {
        console.log('â¸ stopRecording called');
        if (recorder && recorder.state !== 'inactive') {
          recorder.stop();
        }
        if (stream) {
          stream.getTracks().forEach(t => t.stop());
        }
        startBtn.disabled = false;
        stopBtn.disabled  = true;
      });

      // --- ç”»åƒã‚­ãƒ£ãƒ—ãƒãƒ£æ©Ÿèƒ½ï¼ˆçœç•¥ï¼‰ ---
      function capture() {
        if (!videoElem.srcObject) return alert('å…ˆã«éŒ²ç”»ã‚’é–‹å§‹ã—ã¦ãã ã•ã„');
        const c = document.createElement('canvas');
        c.width = 705; c.height = 397;
        c.getContext('2d').drawImage(videoElem, 0, 0);
        const img = document.createElement('img');
        img.src = c.toDataURL('image/png');
        imagesDiv.appendChild(img);
      }
      cap25Btn.addEventListener('click', async () => {
        for (let i=0; i<25; i++){ capture(); await new Promise(r=>setTimeout(r,1000)); }
      });
      cap1_5Btn.addEventListener('click', () => {
        let n=0,iv=setInterval(()=>{
          if (n++>=25) return clearInterval(iv);
          capture();
        },1500);
      });
      clearBtn.addEventListener('click', () => imagesDiv.innerHTML='');

      // --- ffmpeg.wasm ã§ MP4/MP3 ç”Ÿæˆï¼†ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ---
      async function convertWithFFmpeg(webmBlob){
        console.log('ğŸ”„ convertWithFFmpeg start');
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log:true });
        await ffmpeg.load();
        ffmpeg.FS('writeFile','in.webm', await fetchFile(webmBlob));

        // MP4
        await ffmpeg.run(
          '-i','in.webm',
          '-c:v','libx264','-preset','fast','-crf','23',
          '-c:a','aac','-b:a','128k',
          'out.mp4'
        );
        download('out.mp4','recording.mp4','video/mp4');

        // MP3
        await ffmpeg.run(
          '-i','in.webm','-vn',
          '-c:a','libmp3lame','-b:a','128k',
          'out.mp3'
        );
        download('out.mp3','recording.mp3','audio/mp3');

        console.log('âœ… convertWithFFmpeg done');
      }

      function download(nameInFS, fileName, mime){
        const data = ffmpeg.FS('readFile', nameInFS);
        const url  = URL.createObjectURL(new Blob([data.buffer],{type:mime}));
        const a    = document.createElement('a');
        a.href     = url;
        a.download = fileName;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
    });
  </script>
</body>
</html>
